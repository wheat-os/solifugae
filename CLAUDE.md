# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

**Solifugae** 是一个用 Go 语言开发的高性能网络爬虫框架。"solifugae" 这个名字指的是一类被称为骆驼蜘蛛的蛛形纲动物，与框架高效爬取网络的目的相契合。

## 常用开发命令

### 构建和测试
```bash
# 运行所有测试
go test ./...

# 运行测试并显示详细输出
go test -v ./...

# 运行特定包的测试
go test ./core
go test ./spider

# 运行特定测试函数
go test -run TestFunctionName ./package

# 运行测试且不使用缓存
go test -count=1 ./...

# 构建模块
go build ./...

# 整理依赖
go mod tidy
```

## 架构概述

框架基于 **流式架构** 构建，数据以类型化流的形式在系统中流动，并携带元数据。主要组件以工作池模式协同工作，由引擎统一调度。

### 核心组件

1. **核心模块 (`/core/`)** - 基础抽象层：
   - `StreamData` 接口：请求、响应和项目的中心抽象
   - `BaseStream`：带有元数据和上下文的基础实现
   - `HttpStream`：HTTP 特定的流包装器
   - `StreamCodec`：用于持久化的编码/解码

2. **引擎 (`/engine/`)** - 主要调度器：
   - `FastEngine`：带有工作池和优雅关闭的核心引擎
   - 管理组件生命周期并协调工作流程

3. **爬虫系统 (`/spider/`)** - 数据提取：
   - `Spider` 接口：解析逻辑的核心契约
   - `SpiderRefCenter`：使用反射进行自动爬虫方法注册的注册中心
   - 支持现代 Go 迭代器 (`iter.Seq[StreamData]`) 进行高效处理

4. **调度器 (`/scheduler/`)** - 请求队列管理：
   - 用于队列操作的简单接口 (`SetStream`, `GetStream`, `HasPending`)

5. **下载器 (`/downloader/`)** - HTTP 执行：
   - 用于执行带有重试/速率限制的 HTTP 请求的接口

6. **输出器 (`/outputter/`)** - 结果处理：
   - 用于处理和保存抓取数据的接口

7. **工具库 (`/xiter/`)** - 迭代器辅助工具：
   - 用于高效数据处理的自定义迭代器实用程序

### 关键设计模式

- **流式数据流**：所有数据（请求、响应、项目）以带有元数据的流形式流动
- **基于反射的注册**：爬虫方法自动发现和注册
- **迭代器模式**：使用 Go 1.23+ 迭代器进行内存高效处理
- **工作池**：引擎管理并发工作器以实现可扩展性
- **接口驱动**：通过明确定义的接口实现清晰分离

### 组件交互

1. 引擎初始化所有组件
2. 工作器从调度器获取请求
3. 下载器执行 HTTP 请求
4. SpiderRefCenter 将响应路由到适当的爬虫
5. 爬虫使用迭代器生成新的请求或项目
6. 结果被路由回调度器或输出器
7. 过程继续直到没有待处理的请求

## 测试模式

- 使用 `testify` 进行断言
- 测试文件遵循 `*_test.go` 命名约定
- 模拟实现演示接口用法
- 迭代器测试专注于延迟求值行为
- 组件测试验证接口契约

## 开发指南

- 所有组件都应实现各自的接口
- 使用流在组件之间传递数据
- 利用迭代器模式提高内存效率
- 向 SpiderRefCenter 注册爬虫
- 上下文和元数据应通过流元数据流动
- 遵循 Go 的错误处理和包结构约定